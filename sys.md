# 系统设计

## 功能模块

### 1. 租户管理

已完成

### 2. 学时模板管理

已完成

### 3. 课程管理

已完成

### 4. 班级管理

已完成

### 5.排课管理

已有基本框架。
主要问题在自动化排课算法上。

### 6.教室管理

暂不考虑

## 当前任务

重新构建一个独立的自动化排课算法：

### 1.原始数据

上课班级 学生人数 课程名称 学分 周学时 上课周次 任课教师 课程代码 课程类型 开课院系
工程测量技术 23 级 1-3 班 142 测绘法规基础知识 1.5 2.0-0.0 02-16 张保民 1 必修 土木
工程测量技术 23 级 1-3 班 142 BIM 技术应用基础 3 4.0-0.0 02-16 邓秋菊 2 必修 土木
工程测量技术 23 级 1-3 班 142 土木工程监测测量 3 4.0-0.0 02-16 张保民 3 必修 土木
工程测量技术 23 级 1-3 班 142 GIS 技术与应用 3 4.0-0.0 02-16 段秋亚 4 必修 土木
工程测量技术 23 级 1 班 47 建筑节能技术 1.5 2.0-0.0 02-16 肖利才 5 必修 土木
工程测量技术 23 级 2 班 47 建筑节能技术 1.5 2.0-0.0 02-16 肖利才 6 必修 土木
工程测量技术 23 级 3 班 47 建筑节能技术 1.5 2.0-0.0 02-16 肖利才 7 必修 土木
工程测量技术 23 级 1-3 班 142 工程项目招投标与合同管理 ★ 1.5 2.0-0.0 02-16 吴朋金 8 必修 土木
工程测量技术 23 级 1-3 班 142 地图制图技术 ★ 1.5 2.0-0.0 02-16 邢磊 9 必修 土木
工程测量技术 23 级 1-3 班 142 测绘仪器检测与维修 ★ 1.5 2.0-0.0 02-16 周广勇 10 必修 土木
工程测量技术(学徒制)23 级 1 班 45 测绘法规基础知识 2 2.0-0.0 02-16 企业导师 1 11 必修 土木
工程测量技术(学徒制)23 级 1 班 45 无人机测量技术实训 2 2 16-17 企业导师 2 12 必修 土木
工程测量技术(学徒制)23 级 1 班 45 GIS 实训 2 2 18-19 企业导师 3 13 必修 土木
工程测量技术(学徒制)23 级 1 班 45 地图制图技术 3 4.0-0.0 02-16 企业导师 4 14 必修 土木
工程测量技术 24 级 1-3 班 128 无人机测量技术 1.5 2.0-0.0 02-16 邢磊 106 必修 土木
工程测量技术 24 级 1-3 班 128 土木工程 CAD 1.5 2.0-0.0 02-16 林龙 107 必修 土木
工程测量技术 24 级 1-3 班 128 控制测量技术 3 4.0-0.0 02-16 岳崇伦 108 必修 土木
工程测量技术 24 级 1-3 班 128 GPS 定位技术 1.5 2.0-0.0 02-16 周广勇 109 必修 土木
工程测量技术 24 级 1-3 班 128 工程经济 1.5 2.0-0.0 02-16 刘文新 110 必修 土木
工程测量技术(学徒制)24 级 1 班 49 无人机测量技术 2 2.0-0.0 02-16 邢磊 111 必修 土木
工程测量技术(学徒制)24 级 1 班 49 控制测量技术 3 4.0-0.0 02-16 陈伟标 112 必修 土木
工程测量技术(学徒制)24 级 1 班 49 GPS 定位技术 2 2.0-0.0 02-16 周广勇 113 必修 土木
工程测量技术(学徒制)24 级 1 班 49 GPS 定位技术实训 2 2 17-18 段秋亚 114 必修 土木
工程测量技术(学徒制)24 级 1 班 49 控制测量实训 1 1 19-19 王玉娥 115 必修 土木
工程测量技术(学徒制)24 级 1 班 49 GIS 技术与应用 3 4.0-0.0 02-16 段秋亚 116 必修 土木
工程测量技术(学徒制)24 级 1 班 49 测绘仪器检测与维修 2 2.0-0.0 02-16 周广勇 117 必修 土木

### 2. 已入库表结构

1. 教师
   {
   "\_id": {
   "$oid": "6751d3fd9fc1cc6a9cc213fd"
  },
  "tenant": {
    "$oid": "675061cc65838124b873d15f"
   },
   "school": {
   "$oid": "675061cc65838124b873d161"
  },
  "username": "企业导师31733415933297",
  "password": "$2a$10$ABF0o9SAfNaaRFl38ePUY.qJxLgwRLrhykrk4Zi.rXNrZq9VxTM2u",
   "name": "企业导师 3",
   "email": "企业导师31733415933297@example.com",
   "status": "active",
   "roles": [
   "teacher"
   ],
   "profile": {
   "teachingHours": {
   "current": 0,
   "min": 14,
   "max": 16
   },
   "courses": [
   {
   "$oid": "6751d3fd9fc1cc6a9cc21400"
   }
   ]
   },
   "preferences": {
   "notifications": {
   "email": true,
   "web": true
   },
   "theme": "light"
   },
   "createdAt": {
   "$date": "2024-12-05T16:25:33.298Z"
  },
  "updatedAt": {
    "$date": "2024-12-05T16:25:33.367Z"
   },
   "\_\_v": 1
   }
2. 班级
   {
   "\_id": {
   "$oid": "6751d3fc9fc1cc6a9cc21384"
  },
  "tenant": {
    "$oid": "675061cc65838124b873d15f"
   },
   "school": {
   "$oid": "675061cc65838124b873d161"
  },
  "name": "工程测量技术23级1班",
  "department": "工程测量技术",
  "grade": 2023,
  "classNumber": 1,
  "studentCount": 47,
  "courses": [
    {
      "$oid": "6751d3fc9fc1cc6a9cc2138c"
   },
   {
   "$oid": "6751d3fc9fc1cc6a9cc21397"
    },
    {
      "$oid": "6751d3fc9fc1cc6a9cc213a0"
   },
   {
   "$oid": "6751d3fc9fc1cc6a9cc213ab"
    },
    {
      "$oid": "6751d3fc9fc1cc6a9cc213b4"
   },
   {
   "$oid": "6751d3fc9fc1cc6a9cc213cd"
    },
    {
      "$oid": "6751d3fd9fc1cc6a9cc213d8"
   },
   {
   "$oid": "6751d3fd9fc1cc6a9cc213e3"
    }
  ],
  "status": "active",
  "createdAt": {
    "$date": "2024-12-05T16:25:32.633Z"
   },
   "updatedAt": {
   "$date": "2024-12-05T16:25:33.145Z"
   },
   "\_\_v": 0
   }
3. 课程
   {
   "\_id": {
   "$oid": "6751d3fc9fc1cc6a9cc21397"
  },
  "tenant": {
    "$oid": "675061cc65838124b873d15f"
   },
   "school": {
   "$oid": "675061cc65838124b873d161"
  },
  "name": "BIM技术应用基础",
  "code": "2",
  "credit": 3,
  "hours": 4,
  "type": "必修",
  "department": "土木",
  "description": "",
  "teacher": {
    "$oid": "6751d3fc9fc1cc6a9cc21392"
   },
   "classes": [
   {
   "$oid": "6751d3fc9fc1cc6a9cc21384"
   },
   {
   "$oid": "6751d3fc9fc1cc6a9cc21387"
   },
   {
   "$oid": "6751d3fc9fc1cc6a9cc2138a"
   }
   ],
   "status": "active",
   "studentCount": 0,
   "weeks": {
   "start": 2,
   "end": 16
   },
   "version": 1,
   "deletedAt": null,
   "semester": "2024 秋季",
   "createdAt": {
   "$date": "2024-12-05T16:25:32.726Z"
  },
  "updatedAt": {
    "$date": "2024-12-05T16:25:32.726Z"
   },
   "\_\_v": 0
   }
4. 学时模板
   {
   "\_id": {
   "$oid": "67507518d225410871ba37f6"
  },
  "name": "职高模板",
  "description": "都是两节的大课",
  "periods": {
    "morning": [
      {
        "name": "第一节大课",
        "startTime": "08:00",
        "endTime": "09:50",
        "creditHours": 2,
        "_id": {
          "$oid": "6751a5e2b2ceafff0f6627eb"
   }
   },
   {
   "name": "第二节大课",
   "startTime": "10:00",
   "endTime": "11:50",
   "creditHours": 2,
   "\_id": {
   "$oid": "6751a5e2b2ceafff0f6627ec"
        }
      }
    ],
    "afternoon": [
      {
        "name": "第三节大课",
        "startTime": "14:30",
        "endTime": "16:00",
        "creditHours": 2,
        "_id": {
          "$oid": "6751a5e2b2ceafff0f6627e9"
   }
   },
   {
   "name": "第四节大课",
   "startTime": "16:10",
   "endTime": "18:00",
   "creditHours": 2,
   "\_id": {
   "$oid": "6751a5e2b2ceafff0f6627ea"
        }
      }
    ],
    "evening": [
      {
        "name": "第五节大课",
        "startTime": "18:30",
        "endTime": "20:00",
        "creditHours": 2,
        "_id": {
          "$oid": "6751a5e2b2ceafff0f6627e8"
   }
   }
   ]
   },
   "isDefault": false,
   "createdBy": {
   "$oid": "675061cc65838124b873d165"
  },
  "school": {
    "$oid": "675061cc65838124b873d161"
   },
   "createdAt": {
   "$date": "2024-12-04T15:28:24.406Z"
  },
  "updatedAt": {
    "$date": "2024-12-05T13:08:50.111Z"
   },
   "\_\_v": 0,
   "isActive": true
   }

### 3.排课需求

1.首先分好每个班每门课的上课周次。2-16 代表第 2 周一直学到第 16 周。这种课只需要排一次，每周按同样的时间段上课。 2.其次每门课在本周安排的数量。2.0-0.0 代表每周 1 节大课，两个学时，这部分已处理好，为课程数据表中的 hours 字段。 在学时模版中，每个时间段也有 creditHours 字段与之对应。此模板为大课模板，所以每个时间段都为 2 个学时对应一节大课。 3.一个班的同一门课，在一周内最好不要连续上，如需要上 6 课时三节大课，最好安排在一、三、五。 4.排课要检查老师可用的情况，不能重叠。

### 当前问题

按这个需求，帮我分析最适用的排课算法。先不需要写打码，仅仅说一下思路。(已完成)

分析的不错。我将上面提到的数据放到了 server/mock 目录下。我希望你再新建一个 js 文件用来实现算法。全部使用这些 mock 数据作为初始输入值。按照需求分析的结果实现。（已完成）

不错，运行排课的结果为
{
courseId: '6751d3fd9fc1cc6a9cc2146b',
classId: '6751d3fd9fc1cc6a9cc21449',
teacherId: '6751d3fd9fc1cc6a9cc21468',
timeSlot: {
day: '1',
period: '第一节大课',
startTime: '08:00',
endTime: '09:50',
creditHours: 2
},
weeks: [ 19 ]
}
这样的结构，可以稍作调整。timeSlot 可以改成 timeSlotId，因为都是从学时模板中来的。然后这样的 Schema 放到数据库中，我已经新建一个 Schedule2.js 用来存储 mongoose 模型。(已完成)

好的。根据 Schema，我们可以再新建一个 ScheduleController2 来处理排课的逻辑。接口尽量类似之前的 ScheduleController。 只是排课算法使用换过位置的 Algorithm2，里面的传参模式我也做了修改。ScheduleController2 中我们就不适用 mock 数据了，直接查询数据库。（已完成）

看起来很不错。现在还需要新建一个 scheduleRoute2.js，把接口暴露出去供前端使用。(已完成)

我需要进一步优化排课算法 Algorithm2 的代码。首先就是构造函数其他参数不变，添加一个额外可选参数对象 options，用来接收一些额外的配置。比如说第一项是否允许单双周 allowAlternateWeeks, 例如一门课的周课时为 3，学时模版为 2 学时大课，那么一周需要上 1.5 节课，如果设置 allowAlternateWeeks 为 true，那么一周可以上 2 节，下周上 1 节。如果为 false，那么 1.5 视作 2 节，按照 2 节要求排课。第二项参数 allowConsecutivePeriods: 是否允许连续上课，默认为 false，也就是同一课程在同一班级至少隔一天再上，除非周课次数超出每周 3 次的不能拆到 3 天以下。第三项 maxCoursesPerDay: 每天最大课程数，默认不超过 4 个。注意： 你上次帮我写的方式不对，原构造函数有 mockClasses, mockCourses, mockUsers, mockScheduleTemplates 4 个参数，一个都不能丢。 (已完成)

单双周的识别已经没问题了，但是排课结果并没有按单双周处理。
输出的日志：
课程 测绘仪器检测与维修 处理结果: {
original: 3,
processed: { evenWeek: 1, oddWeek: 2, isAlternate: true }
}
初始化排课算法: {
coursesCount: 26,
timeSlotsCount: 25,
options: {
allowAlternateWeeks: true,
allowConsecutivePeriods: false,
maxCoursesPerDay: 4
}
}
[
{
courseId: '6751d3fd9fc1cc6a9cc21479',
classId: '6751d3fd9fc1cc6a9cc21449',
teacherId: '6751d3fd9fc1cc6a9cc213de',
timeSlot: {
day: '1',
period: '第三节大课',
startTime: '14:30',
endTime: '16:00',
creditHours: 2,
id: '6751a5e2b2ceafff0f6627e9'
},
tearcherName: undefined,
weeks: [
2, 3, 4, 5, 6, 7,
8, 9, 10, 11, 12, 13,
14, 15, 16
]
},
{
courseId: '6751d3fd9fc1cc6a9cc21479',
classId: '6751d3fd9fc1cc6a9cc21449',
teacherId: '6751d3fd9fc1cc6a9cc213de',
timeSlot: {
day: '3',
period: '第三节大课',
startTime: '14:30',
endTime: '16:00',
creditHours: 2,
id: '6751a5e2b2ceafff0f6627e9'
},
tearcherName: undefined,
weeks: [
2, 3, 4, 5, 6, 7,
8, 9, 10, 11, 12, 13,
14, 15, 16
]
}
]
可以看到 weeks 数组中，并没有形成单双周的区分。 （已完成）

排课算法已经能用了。现在需要修改 scheduleController2.js 的 generateSchedule 方法。根据前端传入的参数：

```
{
  templateId: "67507518d225410871ba37f6",
  startWeek: 1,
  endWeek: 20,
  minDailyLessons: 2,
  maxDailyLessons: 3,
  allowAlternateWeeks: true,
  considerClassroom: false,
  avoidTimeSlots: [],
  availableSlots: [
    "6751a5e2b2ceafff0f6627eb",
    "6751a5e2b2ceafff0f6627ec",
    "6751a5e2b2ceafff0f6627e9",
    "6751a5e2b2ceafff0f6627ea",
    "6751a5e2b2ceafff0f6627e8",
  ],
}
```

根据 templateId 查询学时模板，根据 availableSlots 查询具体学时对应的时段，查询当前租户学校下所有班级，查询当前学期所有课程和教师，然后进行传参进行排课。 仅仅帮我改造入参，不要修改其他部分。

{
courseId: "6751d3fc9fc1cc6a9cc21397",
classId: "6751d3fc9fc1cc6a9cc21384",
teacherId: "6751d3fc9fc1cc6a9cc21392",
timeSlot: {
day: "1",
period: "第一节大课",
startTime: "08:00",
endTime: "09:50",
creditHours: 2,
id: "6751a5e2b2ceafff0f6627eb",
},
courseName: "BIM 技术应用基础",
weeks: [
2,
3,
4,
5,
6,
7,
8,
9,
10,
11,
12,
13,
14,
15,
16,
],
}
（已完成）

排课成功了，可喜可贺。排课结果保存如 schedule2 表中，数据结构为：

```
{
"_id": "675331e91acbc5017e567d1c",
"tenant": "675061cc65838124b873d15f",
"school": "675061cc65838124b873d161",
"courseId": "6751d3fc9fc1cc6a9cc21397",
"classId": "6751d3fc9fc1cc6a9cc21384",
"teacherId": "6751d3fc9fc1cc6a9cc21392",
"timeSlotId": "6751a5e2b2ceafff0f6627eb",
"dayOfWeek": 1,
"weeks": [
2,
3,
4,
5,
6,
7,
8,
9,
10,
11,
12,
13,
14,
15,
16
],
"status": "draft",
"version": 1,
"semester": "2024秋季",
"__v": 0
}
```

现在我需要改造 scheduleController2.js 和 scheduleRoutes2.js 的接口，为了让前端可以将排课结果查询和渲染回去。
比如前端传入班级 id 和周次，后端返回该班级该周次的排课结果。 （已完成）

看起来不错，现在我需要把修改前端的 api 接口请求，并修改排课管理页面的请求方式，将排课结果的查询接口改成新的。注意还是最小化改动，不要修改其他地方导致已有功能失效。 （已完成）

好的，单周课程表的视图已经完成了，但是不是特别便于浏览查询。
我想在这里做一些变更，首先增加一个浏览模式选择，首先是逐周视图：我们做好的各班级每周课表的查询视图；然后是班级全课程视图，这个模式只需选择班级，然后在每个课程名后面括号显示该课程在哪些周次有安排，如测绘仪器检测与维修（2-16 周），一目了然所有课程分布；最后是教师视图，也是像第二视图一样，全部显示同时括号标注周次。
按这个需求，帮我分析最适用的方案。先不需要写代码，仅仅说一下思路。 （已完成）

我觉得非常棒，我们就按这个思路去完善代码吧。可以的话创建新的文件和组件来进行组织，以免将之前可用的代码损坏。 （已完成）

前后端的路由和组件以及侧边导航栏都已经修改好了。 （已完成）

现在来一个个调试 bug。首先班级课程视图中，班级选择器不工作。（已完成）

好了，班级视图的 bug 已经全部修复了。下一个是教师课程视图。我们先总结一下班级视图中碰到的问题，直接借鉴先来修复教师视图可能得问题。 （已完成）

好了回归正题。我们先来探究一下优化排课算法的事。我们设计了一个选项为课程分布：均衡排课 or 集中排课。这个选项目前还没在算法中考虑，而按照我们之前拟定的不连续排课策略，课程不满的班级几乎都是一三五大量排课，二四为空。这部分如何优化？我们还是先出方案不写代码。（未完成，暂时不考虑）

算法优化先放一放，我觉得先来补齐当下就能用的问题。第一个就是换课。如果我对某班排的某课时间不满意，我希望在排课管理上能直接拖拽换课。一旦拖拽，就需要计算出课程和教师的冲突情况，然后给出提示。比如拖拽到一个周三上午没课的时段，那就需要检测这个老师其他班有没有这个时间的课，如果有，需要给出一个冲突未解决列表。点击可以跳转到这个老师所在冲突班级的课表，继续拖拽，直至冲突列表为空。如果是拖拽到有课 B 的时段，那就需要给出提示，B 也进入冲突列表，迭代解决冲突才完成。我们还是先出思路和方案不写代码。(方案已认可)

我觉得这个方案可行。让我们开始第一步，先实现基础拖拽和单一冲突检测的功能。 （方案已认可）

有一个点是我想要修改的，就是我们当前排课管理的页面，课程表的部分是打算删除废弃的，因为是一个比较早期的设计。现在我想要尽量参照班级课程视图组件 ClassScheduleView.vue，做成一个课程表调整的单独组件。在此基础上帮我改动代码吧。（已完成）
我看到你新添加了两个 api，还是先在后端实现了这两个 api 吧，这样我可以直接在网页上做测试。（已完成）
是的，需要实现前端拖拽，我看到你已经写了一部分拖拽代码（已完成）

拖拽到空闲时段的功能已经没问题了，现在拖拽课程 A 到课 B 的时段，会有一个强制调整按钮，点击没有作用。这和我们的设计不符。有课时段可以放下 A，但是冲突的另一个课程 B 应该进入冲突列表，展示在右侧抽屉中。此时应在渲染 A 的卡片为绿色虚线框代表即将放下，B 的卡片为红色虚线框代表冲突待解决。下一步拖拽 B 后依然使用这套逻辑。 （部分解决）

刚才的调整有挺大的问题，A 放到 B 上后，B 课程有时直接交换到了 A，有时不见了，有时变为了课程 C。请仔细检查逻辑。（已大部分解决）

排课管理有不少小问题，一个个来解决。首先是待处理冲突栏跑到了右侧外面，我建议使用 element-plus 的常驻抽屉组件来解决，有冲突时从右侧展开。待处理冲突里的渲染内容也没有更新。（已完成）

固定抽屉的设计不好。还是两栏布局，左侧是课程表，右侧是冲突列表，左右宽度比例 4:1。不要清空列表按钮 （已完成）

这样好看多了。删除掉移除按钮，因不允许手动清除。拖拽后检测是否不再冲突，如果不再冲突，则从冲突列表中自动移除，同时更新左侧对应的样式。（时灵时不灵，需要调试）

继续调试拖拽和冲突检测的逻辑，首先第一步将课 A 拖到课 B 的位置上，此时的显示逻辑是对的。A 课程绿色虚线外框,B 课程红色虚线外框，而且 B 课程出现在待处理冲突列表中。第二步将 B 拖到 A 课程原来的空位时，此时显示课程调整成功，但是 B 课程还是红色框。而且待处理冲突列表中依然保留着 B 课程。这与设计不符。此时如果已没有冲突，b 课程和 a 课程都应去掉线框，待处理冲突列表中清除 B 课程。（已完成）

改进了一点，还存在问题。现在是第一步将课 A 拖到课 B 的位置上，此时的显示逻辑是对的。A 课程绿色虚线外框,B 课程红色虚线外框，而且 B 课程出现在待处理冲突列表中。第二步将 B 拖到其它位置时，此时显示课程调整成功，A 课程的虚线框也去掉了，但是 B 课程还是红色框。而且待处理冲突列表中依然保留着 B 课程。这与设计不符。此时如果已没有冲突，B 课程应去掉线框，待处理冲突列表中清除 B 课程。（已完成）

很好，这部分解决了！可在冲突检测部分，还需增加教师冲突检测的逻辑。将课 A 拖到课表学时 C 的位置上，还应该检测本教师的所有排课情况：在此 C 位置和周次有没有课？如果有的话也要放到待解决冲突列表中，而且要提示所在班级名。这里班级名应是链接。点击后直接将班级选择器切换到该班级课表。
